{% extends "base.html" %}
{% block title %}Books{% endblock %}
{% block content %}

<style>
  /* --- Split View CSS --- */
  .split-layout { display: grid; grid-template-columns: 1fr; gap: 20px; transition: all 0.3s ease; }
  .split-layout.active { grid-template-columns: 7fr 3fr; }
  .edit-panel { display: none; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); position: sticky; top: 20px; height: fit-content; animation: slideIn 0.3s ease; }
  .edit-panel.show { display: block; }
  @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
  
  /* Sortable Headers */
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { background-color: var(--bg); }
  th.sortable::after { content: ' ‚Üï'; font-size: 0.8em; opacity: 0.5; }


  /* Success Toast Message */
.toast-notification {
    visibility: hidden;
    min-width: 300px;
    background-color: #10b981; /* Green */
    color: #fff;
    text-align: center;
    border-radius: 50px;
    padding: 16px;
    position: fixed;
    z-index: 3000;
    left: 50%;
    top: 30px;
    transform: translateX(-50%);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    font-size: 1rem;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.5s, top 0.5s;
}

.toast-notification.show {
    visibility: visible;
    opacity: 1;
    top: 50px;
}

  /* --- STATUS BADGE COLORS --- */
  .status-tag {
      padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.75rem; text-transform: uppercase;
      display: inline-block; width: 90px; text-align: center; letter-spacing: 0.5px;
  }
  .status-tag.available { background-color: #22c55e; color: white; box-shadow: 0 2px 10px rgba(34, 197, 94, 0.2); }
  
  /* Clickable styles for Borrowed/Lost */
  .status-tag.borrowed { background-color: #f97316; color: white; box-shadow: 0 2px 10px rgba(249, 115, 22, 0.2); }
  .status-tag.borrowed:hover { filter: brightness(1.1); }
  
  .status-tag.lost { background-color: #ef4444; color: white; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.2); }
  .status-tag.lost:hover { filter: brightness(1.1); }

  /* Flash Messages */
  .flash-container { margin-bottom: 20px; }
  .flash { padding: 12px 16px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
  .flash.success { background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; color: #22c55e; }
  .flash.error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; }

  /* Resolution Radio Styles */
  .res-option {
      display: block; padding: 12px; border: 1px solid var(--border);
      border-radius: 8px; margin-bottom: 10px; cursor: pointer;
      transition: 0.2s; text-align: left;
  }
  .res-option:hover { border-color: var(--accent); background: rgba(255, 122, 26, 0.1); }
  .res-option strong { display: block; color: var(--text); margin-bottom: 4px; }
  .res-option small { color: var(--muted-text); }
  /* Selected State */
  input[type="radio"]:checked + .res-option-content { color: var(--accent); }

  @media (max-width: 900px) { .split-layout.active { grid-template-columns: 1fr; } }

  /* Spinner for Modal */
  .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      width: 36px; height: 36px; border-radius: 50%;
      border-left-color: #ff7a1a;
      animation: spin 1s ease infinite;
      margin: 0 auto;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
<div id="successToast" class="toast-notification">‚úÖ Success!</div>
<h1 style="color: var(--accent);">Books Management</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash {{ category }}">
          <span>{{ message }}</span>
          <button onclick="this.parentElement.remove()" style="background:none; border:none; color:inherit; cursor:pointer;">‚úï</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="card" style="margin-bottom: 20px; border-left: 4px solid #ff7a1a;">
    <h3 style="color: #ff7a1a; margin-top:0;">üìÇ Bulk Import via CSV</h3>
    <p style="font-size: 0.9rem; color: var(--muted-text); margin-bottom: 10px;">
        Upload a CSV file to create multiple books at once. 
        <br>Format: <code>Title, Author, Publisher, Year, Call Number, Accession Number</code>
    </p>
    <form action="/books/import" method="post" enctype="multipart/form-data" style="display:flex; gap:10px; align-items:center;">
        <input type="file" name="csv_file" accept=".csv" required style="background: var(--bg); padding: 8px; border-radius: 8px; border: 1px solid var(--border); color: var(--text);">
        <button type="submit" class="btn" style="background: #ff7a1a; height: 42px;">Upload & Generate</button>
    </form>
</section>

<section class="card" style="margin-top:18px; margin-bottom: 24px;">
  <h3 style="color: var(--accent);">Add New Book (Manually)</h3>
  <form action="/books/add" method="post" style="display:flex; gap:10px; flex-wrap:wrap; align-items: flex-end;">
    
    <div style="flex:1; min-width:120px;">
        <label class="small">Title</label>
        <input name="title" placeholder="Title" required style="width:100%; margin:0">
    </div>
    
    <div style="flex:1; min-width:120px;">
        <label class="small">Author</label>
        <input name="author" placeholder="Author" style="width:100%; margin:0">
    </div>
    
    <div style="flex:1; min-width:100px;">
        <label class="small">Publisher</label>
        <input name="publisher" placeholder="Publisher" style="width:100%; margin:0">
    </div>
    
    <div style="flex:1; min-width:80px;">
        <label class="small">Year</label>
        <input name="year" 
               placeholder="YYYY" 
               style="width:100%; margin:0"
               inputmode="numeric"
               maxlength="4"
               pattern="\d{4}"
               title="Please enter a 4-digit year (e.g. 2024)"
               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)"
               required>
    </div>
    
    <div style="flex:1; min-width:100px;">
        <label class="small">Call #</label>
        <input name="call_number" placeholder="Call Num" style="width:100%; margin:0">
    </div>
    
    <div style="flex:1; min-width:120px;">
        <label class="small">Accession</label>
        <input name="accession_number" placeholder="Accession" required style="width:100%; margin:0">
    </div>
    
    <button type="submit" class="btn" style="height: 42px;">Add</button>
  </form>
</section>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h3 style="color: var(--accent); margin:0;">All Books</h3>
    <div style="display:flex; gap:8px;">
      <input type="text" id="searchInput" placeholder="Search Accession or Title..." style="margin:0; width: 250px;">
    </div>
</div>

<div id="splitContainer" class="split-layout">

    <div class="table-container">
        <table id="booksTable" class="books-dark">
            <thead>
            <tr>
                <th class="sortable" onclick="sortTable(0)">Title</th>
                <th class="sortable" onclick="sortTable(1)">Author</th>
                <th class="sortable" onclick="sortTable(2)">Publisher</th>
                <th class="sortable" onclick="sortTable(3)">Year</th>
                <th class="sortable" onclick="sortTable(4)">Call No</th>
                <th class="sortable" onclick="sortTable(5)">Accession</th>
                <th class="sortable" onclick="sortTable(6)">Status</th>
                <th style="min-width:140px;">Action</th>
            </tr>
            </thead>
            <tbody id="booksBody">
            {% for b in books %}
            <tr class="data-row" 
                data-title="{{ b.title }}" data-author="{{ b.author }}"
                data-publisher="{{ b.publisher }}" data-year="{{ b.year }}"
                data-call="{{ b.call_number }}" data-acc="{{ b.accession_number }}"
                data-status="{{ b.status }}">
                
                <td>{{ b.title }}</td>
                <td>{{ b.author or '-' }}</td>
                <td>{{ b.publisher or '-' }}</td>
                <td>{{ b.year or '-' }}</td>
                <td>{{ b.call_number or '-' }}</td>
                <td>{{ b.accession_number }}</td>
                
                <td>
                  {% set s = (b.status|string).lower() %}
                  <span class="status-tag {{ s }}"
                        {% if s == 'borrowed' or s == 'lost' %}
                          style="cursor:pointer; text-decoration:underline; text-underline-offset:3px;"
                          onclick="showBorrowerInfo('{{ b.accession_number }}', '{{ b.title|escape }}'); event.stopPropagation();"
                          title="Click to see borrower details"
                        {% endif %}>
                      {{ b.status }}
                  </span>
                </td>

                <td>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-sm" onclick="openEditPanel(this)">Edit</button>
                    
                    {% if b.status == 'Lost' %}
                    <button type="button" class="btn btn-sm" 
                            style="background-color: #10b981; color: white; box-shadow: var(--shadow);"
                            title="Replacement Received"
                            onclick="openResolveModal(this)">
                        ‚úÖ Resolve
                    </button>
                    {% endif %}

                    <button type="button" class="btn btn-sm" style="background-color: #ef4444; color: white; box-shadow: var(--shadow);"
                            data-url="{{ url_for('books_delete', accession_number=b.accession_number) }}"
                            onclick="openDeleteModal(this.dataset.url)">Delete</button>
                </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        
        <div id="pager" style="margin-top:12px; display:flex; gap:10px; justify-content: flex-end; align-items:center;">
            <button class="btn btn-sm" id="prevBtn">‚Äπ Prev</button>
            <span class="small" id="pageInfo">Page 1</span>
            <button class="btn btn-sm" id="nextBtn">Next ‚Ä∫</button>
        </div>
    </div>

    <div id="editPanel" class="edit-panel">
        <h3 style="color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px;" id="editHeader">Edit Book</h3>

        <form id="editBookForm" method="POST" action="">
            <div style="margin-bottom: 12px;">
                <label class="small">Accession (Read Only)</label>
                <input id="editAccDisplay" name="accession_number" disabled style="width: 100%; background: #1f2937; cursor: not-allowed; margin:0; color: #9ca3af;">
            </div>
            <div style="margin-bottom: 12px;"><label class="small">Title</label><input name="title" id="editTitle" required style="width: 100%; margin:0;"></div>
            <div style="margin-bottom: 12px;"><label class="small">Author</label><input name="author" id="editAuthor" style="width: 100%; margin:0;"></div>
            <div style="margin-bottom: 12px;"><label class="small">Publisher</label><input name="publisher" id="editPublisher" style="width: 100%; margin:0;"></div>
            <div style="margin-bottom: 12px;"><label class="small">Year</label><input name="year" id="editYear" style="width: 100%; margin:0;"></div>
            <div style="margin-bottom: 12px;"><label class="small">Call Number</label><input name="call_number" id="editCall" style="width: 100%; margin:0;"></div>
            
            <div style="margin-bottom: 20px;" id="statusGroup">
                <label class="small">Status</label>
                <select name="status" id="editStatus" style="width: 100%; margin:0; padding: 10px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 10px;">
                    <option value="Available">Available</option>
                    <option value="Borrowed">Borrowed</option>
                    <option value="Lost">Lost</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button type="submit" class="btn" style="flex:1" id="editSaveBtn">Save</button>
                <button type="button" class="btn" style="background: var(--border); color: var(--text); flex:1" onclick="closeEditPanel()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="deleteModal" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000;">
  <div class="modal-box" style="background: var(--surface); border: 1px solid var(--border); padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center;">
    <h3 style="color:#ef4444; margin-top:0;">‚ö†Ô∏è Confirm Deletion</h3>
    <p>Are you sure you want to delete this book?</p>
    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
      <button class="btn" style="background:var(--bg); border:1px solid var(--border);" onclick="document.getElementById('deleteModal').style.display='none'">Cancel</button>
      <form id="confirmDeleteForm" method="POST" action="">
        <button type="submit" class="btn" style="background:#ef4444; border:none;">Yes, Delete</button>
      </form>
    </div>
  </div>
</div>

<div id="resolveModal" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000;">
  <div class="modal-box" style="background:var(--surface); padding:30px; border:1px solid #10b981; max-width:450px; text-align:center; border-radius:16px;">
    <h3 style="color:#10b981; margin-top:0;">üìö Resolve Lost Book</h3>
    <p>How is the student replacing this item?</p>
    
    <div style="text-align:left; margin: 20px 0;">
        <label class="res-option">
            <input type="radio" name="res_type" value="same" checked onchange="updateResolveBtn()"> 
            <span class="res-option-content">
                <strong>1. Exact Replacement</strong>
                <small>Student will replace with the exact same book edition/title.</small>
            </span>
        </label>
        <label class="res-option">
            <input type="radio" name="res_type" value="different" onchange="updateResolveBtn()"> 
            <span class="res-option-content">
                <strong>2. Similar Value/Book</strong>
                <small>This will resolve the transaction and <b>replace</b> the lost book from the database.</small>
            </span>
        </label>
    </div>
    
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#10b981; flex:1;" id="resolveSubmitBtn" onclick="proceedResolve()">Confirm</button>
        <button class="btn" style="background:var(--bg); border:1px solid var(--border); flex:1;" onclick="document.getElementById('resolveModal').style.display='none'">Cancel</button>
    </div>
  </div>
</div>

<div id="borrowerModal" class="modal-overlay" 
     style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px);">
  
  <div class="modal-box" style="text-align:left; max-width: 450px; width:90%; background:var(--surface); padding:20px; border-radius:12px; border:1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="color: var(--accent); margin:0;">Book Status</h3>
        <button onclick="document.getElementById('borrowerModal').style.display='none'" 
                style="background:none; border:none; color:var(--text); font-size:1.5rem; cursor:pointer; padding:0; line-height:1;">&times;</button>
    </div>
    
    <div id="borrowerContent">Loading...</div>
  </div>
</div>

<script>
  let selectedRowForResolve = null;

  function openResolveModal(btn) {
      selectedRowForResolve = btn.closest('tr');
      // Reset to default
      document.querySelectorAll('input[name="res_type"]').forEach(r => r.checked = false);
      document.querySelector('input[name="res_type"][value="same"]').checked = true;
      updateResolveBtn();
      document.getElementById('resolveModal').style.display = 'flex';
  }

  function updateResolveBtn() {
      const type = document.querySelector('input[name="res_type"]:checked').value;
      const btn = document.getElementById('resolveSubmitBtn');
      if (type === 'same') {
          btn.innerText = "Confirm";
      } else {
          btn.innerText = "Submit"; 
      }
  }

  // --- Helper to show the Toast Message ---
  function showToast(message) {
      const toast = document.getElementById("successToast");
      toast.innerText = "‚úÖ " + message;
      toast.className = "toast-notification show";
      // Hide after 3 seconds (fallback)
      setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
  }

  async function proceedResolve() {
      const type = document.querySelector('input[name="res_type"]:checked').value;
      const acc = selectedRowForResolve.dataset.acc;
      const btn = document.getElementById('resolveSubmitBtn');
      
      // 1. LOADING STATE
      const originalText = btn.innerText;
      btn.innerText = "‚è≥ Processing...";
      btn.disabled = true;
      btn.style.opacity = "0.7";

      try {
          let url = "";
          let successMsg = "";

          if (type === 'same') {
              // Option 1: Exact Replacement
              url = `/books/resolve_lost/${acc}`;
              successMsg = "Book Resolved & Available";
          } else {
              // Option 2: Similar Value / Delete
              url = `/books/resolve_delete/${acc}`;
              successMsg = "You successfully resolved the lost book";
          }

          // 2. SEND REQUEST (Use FETCH for both to control the UI)
          const res = await fetch(url, { method: 'POST' });
          
          // Note: Option 1 returns a redirect (HTML), Option 2 returns JSON.
          // We check res.ok for both.
          if (res.ok) {
              // Close the modal immediately
              document.getElementById('resolveModal').style.display = 'none';
              
              // 3. SHOW POPUP MESSAGE
              showToast(successMsg);

              // 4. WAIT 2 SECONDS THEN RELOAD
              setTimeout(() => {
                  window.location.reload();
              }, 2000);

          } else {
              // Handle Errors
              const data = await res.json().catch(() => ({})); // Safe fallback if response isn't JSON
              alert("Error: " + (data.message || "Request failed"));
              resetBtn();
          }

      } catch (e) {
          console.error(e);
          alert("System Error: Connection failed.");
          resetBtn();
      }

      function resetBtn() {
          btn.innerText = originalText;
          btn.disabled = false;
          btn.style.opacity = "1";
      }
  }

  // --- UPDATED SHOW BORROWER INFO (Uses New API) ---
  async function showBorrowerInfo(acc, title) {
    const modal = document.getElementById('borrowerModal');
    const content = document.getElementById('borrowerContent');
    
    modal.style.display = 'flex';
    content.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div><p style="color:gray; margin-top:10px;">Finding student...</p></div>';
    
    try {
        // Use the API that gets the LATEST info, regardless of current status
        const res = await fetch(`/api/book-status/${encodeURIComponent(acc)}`);
        
        if(!res.ok) {
            throw new Error("No record found");
        }
        
        const data = await res.json();
        
        content.innerHTML = `
          <div style="text-align:center; margin-bottom:15px;">
            <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom:5px;">Book Title</p>
            <h3 style="color:var(--accent); margin:0;">${title}</h3>
            <span style="font-family:monospace; color:#6b7280; font-size:0.85rem;">${acc}</span>
          </div>

          <div style="background: #1f2937; padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
              <div style="display:grid; grid-template-columns: auto 1fr; gap: 10px; align-items:center; margin-bottom:10px;">
                  <span style="background:#374151; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%;">üë§</span>
                  <div>
                      <div style="font-weight:bold; color:white; font-size:1.1rem;">${data.student_name}</div>
                      <div style="font-family:monospace; color:var(--accent);">${data.student_number}</div>
                  </div>
              </div>
              
              <hr style="border-color: #374151; margin: 15px 0;">
              
              <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                  <span style="color:#9ca3af;">Last Action:</span>
                  <span style="color:white;">${data.tx_date}</span>
              </div>
              <div style="display:flex; justify-content:space-between;">
                  <span style="color:#9ca3af;">Due Date:</span>
                  <span style="color:${data.due_date ? '#f97316' : '#9ca3af'};">${data.due_date || 'N/A'}</span>
              </div>
              
              <div style="margin-top:15px; background:#111827; padding:10px; border-radius:8px; font-size:0.9rem;">
                  <span style="color:#9ca3af;">üìß Contact:</span> <span style="color:white;">${data.contact || 'No email'}</span>
              </div>
          </div>
        `;
    } catch(e) { 
        content.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <h3 style="color:#ef4444;">‚úï Not Found</h3>
                <p style="color:#9ca3af;">No recent history found for this book.</p>
            </div>`; 
    }
  }

  function openDeleteModal(url) {
    document.getElementById('confirmDeleteForm').action = url;
    document.getElementById('deleteModal').style.display = 'flex';
  }

  function openEditPanel(btn) {
    const tr = btn.closest('tr');
    const acc = tr.dataset.acc;
    
    document.getElementById('editAccDisplay').value = acc;
    document.getElementById('editTitle').value = tr.dataset.title;
    document.getElementById('editAuthor').value = tr.dataset.author || '';
    document.getElementById('editPublisher').value = tr.dataset.publisher || '';
    document.getElementById('editYear').value = tr.dataset.year || '';
    document.getElementById('editCall').value = tr.dataset.call || '';
    document.getElementById('editStatus').value = tr.dataset.status || 'Available';
    
    document.getElementById('editBookForm').action = "/books/edit/" + acc;
    
    document.getElementById('splitContainer').classList.add('active');
    document.getElementById('editPanel').classList.add('show');
  }
  
  function closeEditPanel() {
    document.getElementById('splitContainer').classList.remove('active');
    document.getElementById('editPanel').classList.remove('show');
  }

  const allRows = Array.from(document.querySelectorAll('#booksTable tbody tr'));
  let filteredRows = allRows; 
  let current = 1;
  const perPage = 8;
  let sortDirection = 1;

  document.getElementById('searchInput').addEventListener('keyup', function(e) {
    const term = e.target.value.toLowerCase();
    filteredRows = allRows.filter(row => row.innerText.toLowerCase().includes(term));
    current = 1;
    renderTable();
  });

  function renderTable() {
    const totalPages = Math.ceil(filteredRows.length / perPage) || 1;
    if(current > totalPages) current = totalPages;
    allRows.forEach(r => r.style.display = 'none');
    const start = (current - 1) * perPage;
    const end = start + perPage;
    filteredRows.forEach((r, index) => { if(index >= start && index < end) r.style.display = 'table-row'; });
    document.getElementById('pageInfo').textContent = `Page ${current} / ${totalPages}`;
    document.getElementById('prevBtn').disabled = current <= 1;
    document.getElementById('nextBtn').disabled = current >= totalPages;
    document.getElementById('prevBtn').style.opacity = current <= 1 ? 0.5 : 1;
    document.getElementById('nextBtn').style.opacity = current >= totalPages ? 0.5 : 1;
  }

  document.getElementById('prevBtn').onclick = () => { if(current > 1) { current--; renderTable(); }};
  document.getElementById('nextBtn').onclick = () => { 
      const totalPages = Math.ceil(filteredRows.length / perPage) || 1;
      if(current < totalPages) { current++; renderTable(); }
  };

  window.sortTable = function(colIndex) {
    filteredRows.sort((a, b) => {
        const valA = a.children[colIndex].textContent.trim().toLowerCase();
        const valB = b.children[colIndex].textContent.trim().toLowerCase();
        return (valA < valB ? -1 : 1) * sortDirection;
    });
    sortDirection *= -1;
    current = 1;
    const tbody = document.getElementById('booksBody');
    filteredRows.forEach(row => tbody.appendChild(row));
    renderTable();
  }
  renderTable();
</script>

{% endblock %}