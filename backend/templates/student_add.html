<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Add Student</title>  
</head>
{% extends "base.html" %}
{% block title %}Borrowers{% endblock %}
{% block content %}

<style>
  /* --- Split View Layout CSS --- */
  .split-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    transition: all 0.3s ease;
  }
  .split-layout.active {
    grid-template-columns: 7fr 3fr; /* 70% Table, 30% Form */
  }
  .edit-panel {
    display: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    box-shadow: var(--shadow);
    position: sticky;
    top: 20px;
    height: fit-content;
    animation: slideIn 0.3s ease;
  }
  .edit-panel.show { display: block; }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  /* --- Sortable Headers --- */
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { background-color: var(--bg); }
  th.sortable::after { content: ' ↕'; font-size: 0.8em; opacity: 0.5; }

  @media (max-width: 900px) {
    .split-layout.active { grid-template-columns: 1fr; }
  }
</style>

{% with msgs = get_flashed_messages(with_categories=True) %}
  {% if msgs %}
    <div id="flash-area" style="max-width:720px; margin:10px auto;">
      {% for category, message in msgs %}
        {% set cat = category if category in ['error','success','info'] else 'info' %}
        <div class="flash {{ cat }}">
          <span>{{ message }}</span>
          <button type="button" onclick="this.parentElement.remove()">✕</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<h1 style="color: var(--accent);">Borrowers</h1>

<!-- ADD STUDENT FORM -->
<section class="card" style="margin-bottom: 24px;">
  <h3 style="color: var(--accent);">Register New Student</h3>
  <form action="{{ url_for('students_add') }}" method="post" style="display:flex; gap:8px; flex-wrap:wrap; align-items: flex-end;">
    <div style="flex:1; min-width:140px;">
      <label class="small">Student No</label>
      <input name="student_number" placeholder="e.g. 23-0717" required 
             pattern="^\d{2}-\d{4}$" 
             title="Format: XX-XXXX (e.g., 23-0717)"
             oninvalid="this.setCustomValidity('Please enter a valid Student No. format: XX-XXXX (e.g., 23-0717)')"
             oninput="this.setCustomValidity('')"
             style="margin:0; width:100%;">
    </div>
    <div style="flex:1; min-width:140px;">
      <label class="small">Full Name</label>
      <input name="student_name" placeholder="Full Name" required style="margin:0; width:100%;">
    </div>
    <div style="flex:1; min-width:140px;">
      <label class="small">Course</label>
      <input name="course" placeholder="Course" style="margin:0; width:100%;">
    </div>
    <div style="flex:1; min-width:140px;">
      <label class="small">Dept</label>
      <input name="department" placeholder="Dept" style="margin:0; width:100%;">
    </div>
    <div style="flex:1; min-width:140px;">
      <label class="small">Email</label>
      <input name="contact" placeholder="Email" style="margin:0; width:100%;">
    </div>
    <!-- Password Input Removed: Auto-generated in backend -->
    <button style="height: 42px;" class="btn">Add</button>
  </form>
</section>

<!-- Search (Real-time) -->
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h2 style="color: var(--accent); margin:0;">Student List</h2>
    <!-- Removed action/method to prevent reload, added ID for JS -->
    <div style="display:flex; gap:8px;">
        <input type="text" id="searchInput" placeholder="Search by name, no, dept..." style="margin:0; width: 250px;">
    </div>
</div>

<!-- SPLIT LAYOUT CONTAINER -->
<div id="splitContainer" class="split-layout">
    
    <!-- LEFT: Table -->
    <div class="table-container">
        <table id="studentsTable">
            <thead>
                <tr>
                    <th class="sortable" onclick="sortTable(0)">Student No</th>
                    <th class="sortable" onclick="sortTable(1)">Name</th>
                    <th class="sortable" onclick="sortTable(2)">Course</th>
                    <th class="sortable" onclick="sortTable(3)">Dept</th>
                    <th class="sortable" onclick="sortTable(4)">Contact</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="studentsBody">
            {% for s in students %}
                <tr>
                    <td><a href="{{ url_for('student_details', student_number=s.student_number) }}">{{ s.student_number }}</a></td>
                    <td>{{ s.student_name }}</td>
                    <td>{{ s.course or '-' }}</td>
                    <td>{{ s.department or '-' }}</td>
                    <td>{{ s.contact or '-' }}</td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="btn btn-sm" onclick="openEditPanel('{{ s.student_number }}')">Edit</button>
                            <button type="button" class="btn btn-sm" 
                                    style="background-color: #ef4444; color: white; box-shadow: var(--shadow);"
                                    data-url="{{ url_for('students_delete', student_number=s.student_number) }}"
                                    onclick="openDeleteModal(this.dataset.url)">
                            Delete
                            </button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <!-- Pagination Controls -->
        <div id="pager" style="margin-top:12px; display:flex; gap:10px; justify-content: flex-end; align-items:center;">
            <button class="btn btn-sm" id="prevBtn">‹ Prev</button>
            <span class="small" id="pageInfo">Page 1</span>
            <button class="btn btn-sm" id="nextBtn">Next ›</button>
        </div>
    </div>

    <!-- RIGHT: Edit Panel -->
    <div id="editPanel" class="edit-panel">
        <h3 style="color: var(--accent); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Edit Student</h3>
        
        <form id="editStudentForm">
            <input type="hidden" id="editStudentNumber" name="student_number">
            
            <div style="margin-bottom: 15px;">
                <label class="small" style="display:block;">Student Number (Read Only)</label>
                <input type="text" id="displayStudentNumber" disabled style="background: #1f2937; cursor: not-allowed; width: 100%;">
            </div>
            <div style="margin-bottom: 15px;">
                <label class="small">Name</label>
                <input type="text" id="editStudentName" name="student_name" required style="width: 100%; margin:0;">
            </div>
            <div style="margin-bottom: 15px;">
                <label class="small">Course</label>
                <input type="text" id="editStudentCourse" name="course" style="width: 100%; margin:0;">
            </div>
            <div style="margin-bottom: 15px;">
                <label class="small">Department</label>
                <input type="text" id="editStudentDepartment" name="department" style="width: 100%; margin:0;">
            </div>
            <div style="margin-bottom: 20px;">
                <label class="small">Contact</label>
                <input type="text" id="editStudentContact" name="contact" style="width: 100%; margin:0;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn" style="flex:1;">Save Changes</button>
                <button type="button" class="btn" style="background: var(--border); color: var(--text); flex:1;" onclick="closeEditPanel()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<style>
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
  .modal-box { background: var(--surface); border: 1px solid var(--border); padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: var(--shadow); text-align: center; }
  .modal-actions { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
  .btn-cancel { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn-confirm-delete { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }
</style>

<div id="deleteModal" class="modal-overlay">
  <div class="modal-box">
    <h3 style="color:#ef4444; margin-top:0;">⚠️ Confirm Deletion</h3>
    <p>Are you sure you want to delete this student?<br><span style="font-size:0.85em; color:var(--muted-text);">This will also delete all their transaction history.</span></p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="document.getElementById('deleteModal').style.display='none'">Cancel</button>
      <form id="confirmDeleteForm" method="POST" action="">
        <button type="submit" class="btn-confirm-delete">Yes, Delete</button>
      </form>
    </div>
  </div>
</div>

<script>
  // --- Delete Modal Logic ---
  function openDeleteModal(url) {
    document.getElementById('confirmDeleteForm').action = url;
    document.getElementById('deleteModal').style.display = 'flex';
  }

  // --- Split View Logic ---
  function openEditPanel(studentNumber) {
    fetch(`/api/student/${studentNumber}`)
      .then(res => res.json())
      .then(data => {
        if(data.error) return alert('Error fetching student');
        document.getElementById('editStudentNumber').value = data.student_number;
        document.getElementById('displayStudentNumber').value = data.student_number;
        document.getElementById('editStudentName').value = data.student_name;
        document.getElementById('editStudentCourse').value = data.course || '';
        document.getElementById('editStudentDepartment').value = data.department || '';
        document.getElementById('editStudentContact').value = data.contact || '';
        document.getElementById('splitContainer').classList.add('active');
        document.getElementById('editPanel').classList.add('show');
      })
      .catch(err => console.error(err));
  }

  function closeEditPanel() {
    document.getElementById('splitContainer').classList.remove('active');
    document.getElementById('editPanel').classList.remove('show');
  }

  // Handle Edit Form Submit
  document.getElementById('editStudentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const sNum = document.getElementById('editStudentNumber').value;
    const formData = {};
    new FormData(this).forEach((value, key) => formData[key] = value);
    fetch(`/students/edit/${sNum}`, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(formData)
    }).then(r => r.json()).then(data => {
        if(data.success) { alert('✅ Updated successfully'); location.reload(); } 
        else { alert('Update failed'); }
    });
  });

  // --- REAL-TIME SEARCH, SORT & PAGINATION ---
  
  // 1. Capture all rows initially
  const allRows = Array.from(document.querySelectorAll('#studentsTable tbody tr'));
  let filteredRows = allRows; // Init with all rows
  let current = 1;
  const perPage = 10;
  let sortDirection = 1;

  // Search Event Listener
  document.getElementById('searchInput').addEventListener('keyup', function(e) {
    const term = e.target.value.toLowerCase();
    
    // Filter the MASTER list
    filteredRows = allRows.filter(row => {
        return row.innerText.toLowerCase().includes(term);
    });
    
    current = 1; // Reset to page 1 on search
    renderTable();
  });

  function renderTable() {
    const totalPages = Math.ceil(filteredRows.length / perPage) || 1;
    if(current > totalPages) current = totalPages;
    
    // Hide ALL rows first
    allRows.forEach(r => r.style.display = 'none');
    
    // Calculate slice indices based on FILTERED rows
    const start = (current - 1) * perPage;
    const end = start + perPage;
    
    const tbody = document.getElementById('studentsBody');
    // Only append the visible slice of the filtered rows
    // Note: If we just append, we lose the original DOM order if we clear innerHTML. 
    // But since we hide allRows first, we can just show the ones we need.
    
    filteredRows.forEach((r, index) => {
        if(index >= start && index < end) {
            r.style.display = 'table-row';
        }
    });

    document.getElementById('pageInfo').textContent = `Page ${current} / ${totalPages}`;
    document.getElementById('prevBtn').disabled = current <= 1;
    document.getElementById('nextBtn').disabled = current >= totalPages;
    document.getElementById('prevBtn').style.opacity = current <= 1 ? 0.5 : 1;
    document.getElementById('nextBtn').style.opacity = current >= totalPages ? 0.5 : 1;
  }

  document.getElementById('prevBtn').onclick = () => { if(current > 1) { current--; renderTable(); }};
  document.getElementById('nextBtn').onclick = () => { 
    const totalPages = Math.ceil(filteredRows.length / perPage) || 1;
    if(current < totalPages) { current++; renderTable(); }
  };

  window.sortTable = function(colIndex) {
    // Sort the CURRENT FILTERED LIST
    filteredRows.sort((a, b) => {
        const valA = a.children[colIndex].textContent.trim().toLowerCase();
        const valB = b.children[colIndex].textContent.trim().toLowerCase();
        return (valA < valB ? -1 : 1) * sortDirection;
    });
    sortDirection *= -1; 
    current = 1;
    
    // Re-append sorted rows to body so they appear in correct order physically
    const tbody = document.getElementById('studentsBody');
    filteredRows.forEach(row => tbody.appendChild(row));
    
    renderTable();
  }

  // Initial Render
  renderTable();
</script>

{% endblock %}
</html>