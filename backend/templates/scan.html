<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>QR Scanner</title>
  <style>
    html, body { height:100%; margin:0; }
    body { background:#000; color:#fff; font-family:system-ui, Arial, sans-serif;
           display:flex; flex-direction:column; }
    header { padding:8px 12px; background:#111; border-bottom:1px solid #222; }
    header button { background:#444; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    main { flex:1; display:flex; align-items:center; justify-content:center; padding:10px; }
    #qr-reader { width:min(100vw, 720px); max-width:720px; border-radius:12px; overflow:hidden; }
    #qr-reader video { width:100% !important; height:auto !important; }
  </style>
</head>
<body>
  <header>
    <button onclick="window.close()">Close</button>
  </header>
  <main>
    <div id="qr-reader"></div>
  </main>

  <!-- 1) Load the QR library -->
  <script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}"></script>

  <!-- 2) Start scanner and post result back -->
  <script>
    function onScanFailure(_) { /* silent */ }

    async function onScanSuccess(decodedText) {
      try {
        // Look up the student info using your existing API
        const res = await fetch('/api/student/' + encodeURIComponent(decodedText));
        const data = await res.json();

        if (!res.ok || data.error) {
          alert(data.error || 'Student not found.');
          return;
        }

        // âœ… Send student data back to the opener (Transactions tab)
        if (window.opener) {
          window.opener.postMessage({ type: 'studentScanned', student: data }, window.location.origin);
        } else {
          alert('No opener window found.');
        }

        // Close the scanner popup
        window.close();
      } catch (e) {
        console.error(e);
        alert('Network error while fetching student.');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const scanner = new Html5QrcodeScanner(
        "qr-reader",
        { fps: 10, qrbox: 280, rememberLastUsedCamera: true, showTorchButtonIfSupported: true },
        false
      );
      scanner.render(onScanSuccess, onScanFailure);
    });
  </script>
</body>
</html>
